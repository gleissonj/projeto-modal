version: 1

default_profile: prd

profiles:
  dev:
    env: dev
    paths:
      bucket_raw: s3://itau-corp-artifact-sa-east-1-019163564458
      folder_raw: raw/salesforce/opportunity
      bucket_sor: s3://itau-corp-artifact-sa-east-1-019163564458
      folder_sor: sor/gestaocomercial/opportunity
    write:
      show_counts: true
      repartition: 1  # força 1 arquivo por partição em DEV
    dq:
      enable: true
      mode: builder   # usa o RuleSetBuilder (como no script original)
      builder:
        owner: dataops
        team: ibba360
        rules:
          - type: IsComplete
            column: cod_idt
          - type: IsComplete
            column: des_ctrl_alter
          - type: RowCount
            operator: ">="
            expression: 1
          - type: ColumnLength
            column: des_ctrl_alter
            operator: ">="
            expression: 1

  hml:
    env: hml
    paths:
      bucket_raw: s3://itau-corp-artifact-sa-east-1-019163564458
      folder_raw: raw/salesforce/opportunity
      bucket_sor: s3://itau-corp-artifact-sa-east-1-019163564458
      folder_sor: sor/gestaocomercial/opportunity
    write:
      show_counts: false
      repartition: 1
    dq:
      enable: true
      mode: builder
      builder:
        owner: dataops
        team: ibba360
        rules:
          - type: IsComplete
            column: cod_idt
          - type: IsComplete
            column: des_ctrl_alter
          - type: RowCount
            operator: ">="
            expression: 1
          - type: ColumnLength
            column: des_ctrl_alter
            operator: ">="
            expression: 1

  prd:
    env: prd
    paths:
      bucket_raw: s3://itau-corp-artifact-sa-east-1-019163564458
      folder_raw: raw/salesforce/opportunity
      bucket_sor: s3://itau-corp-artifact-sa-east-1-019163564458
      folder_sor: sor/gestaocomercial/opportunity
    write:
      show_counts: false
      repartition: 0  # 0 = sem repartition explícito
    dq:
      enable: true
      mode: builder
      builder:
        owner: dataops
        team: ibba360
        rules:
          - type: IsComplete
            column: cod_idt
          - type: IsComplete
            column: des_ctrl_alter
          - type: RowCount
            operator: ">="
            expression: 1
          - type: ColumnLength
            column: des_ctrl_alter
            operator: ">="
            expression: 1

# -------------------- Comum a todos os ambientes --------------------
meta:
  owner_team_email: "eduardo.goncalves-silva@itau-unibanco.com.br"
  tech_team_email:  "43-engajamento.digital@Conectados.onmicrosoft.com"
  product_name: "democratizacao-salesforce-contatos"
  repository_name: "itau-kn8-app-gluejobsalesforce-contact"
  squad: "EngajamentoDigital"
  sigla: "kn8"
  servico_negocio: "democratizar dados do ibba 360"
  comunidade: "IBBA"

job:
  name: gc-sf-raw2sor-oportunidade
  description: "Democratizar dados de oportunidade do IBBA 360"
  database: db_corp_gestaocomercial_governancasalesforceibba_sor_01
  table: tb_ibba360_evento_oportunidade

# ⚠️ Booleans obrigatórios no código estrito
window:
  force: false
  start_date: 2025-03-13
  end_date: 2025-09-04
  days_retro: 1
  max_days_back: 720

read:
  input_format: csv
  csv:
    delimiter: ";"
    header: true
    encoding: utf-8
    multiline: true
    quote_mode: STOP_AT_CLOSING_QUOTE
    ignore_leading_whitespace: true
    ignore_trailing_whitespace: true

schema:
  columns:
    AccountId: StringType
    Amount: DoubleType
    Budget_Confirmed__c: BooleanType
    CampaignId: StringType
    CloseDate: StringType
    CreatedById: StringType
    CreatedDate: StringType
    Description: StringType
    Discovery_Completed__c: BooleanType
    Fiscal: StringType
    FiscalQuarter: IntegerType
    FiscalYear: IntegerType
    ForecastCategory: StringType
    ForecastCategoryName: StringType
    HasOpenActivity: BooleanType
    HasOpportunityLineItem: BooleanType
    HasOverdueTask: BooleanType
    Id: StringType
    IsClosed: BooleanType
    IsDeleted: BooleanType
    IsWon: BooleanType
    LastActivityDate: StringType
    LastModifiedById: StringType
    LastModifiedDate: StringType
    LastStageChangeDate: StringType
    LastViewedDate: StringType
    LastReferencedDate: StringType
    LeadSource: StringType
    Name: StringType
    NextStep: StringType
    OwnerId: StringType
    Pricebook2Id: StringType
    Probability: IntegerType
    PushCount: IntegerType
    RecordTypeId: StringType
    StageName: StringType
    SyncedQuoteId: StringType
    SystemModstamp: StringType
    Territory2Id: StringType
    Type: StringType
    HU7_MotivoPerda__c: StringType
    HU7_SubMotivoPerda__c: StringType
    HU7_SpreadConcorrente__c: DoubleType
    HU7_Probabilidade__c: StringType
    AccountIdSubGrupo__c: StringType
    DataVencimentoConcorrente__c: StringType
    EspecialistaTime__c: StringType
    ExpectedRevenue: DoubleType
    HU7_Concorrente__c: StringType
    HU7_ContactReport__c: StringType
    HU7_Detalhes__c: StringType
    HU7_EmpresaGrupo__c: StringType
    HU7_EstimativaPotencial__c: DoubleType
    HU7_IDExterno__c: StringType
    HU7_IdVencimento__c: StringType
    HU7_NomeOferta__c: StringType
    HU7_Restrito__c: BooleanType
    InformacaoAdicional__c: StringType
    IsPrivate: BooleanType
    Participantes__c: StringType
    TotalOpportunityQuantity: StringType
  optional_columns: []

time:
  partition_source_col: SystemModstamp
  partition_source_fmt: "yyyy-MM-dd'T'HH:mm:ss.SSS'Z'"
  partition_target_col: cod_patc
  partition_target_format: yyyyMMdd
  timezone_target: America/Sao_Paulo           # ativa *_adj e preferência automática
  technical_timestamp_tz: America/Sao_Paulo    # dat_hor_psst em BR

transform:
  alias_map:
    CreatedDate: dat_cria
    LastActivityDate: dat_ulti_atii
    LastModifiedDate: dat_ulti_alte
    LastReferencedDate: dat_ulti_rfrc
    LastStageChangeDate: dat_ulti_muda_esta
    LastViewedDate: dat_ulti_visu
    SystemModstamp: dat_alte_dado
    AccountId: num_idt_cont
    Amount: vlr_esmd_vend
    Budget_Confirmed__c: ind_orcm_cfmd_c
    CampaignId: num_idt_camp
    CloseDate: dat_fecm
    CreatedById: des_idt_ctto
    Description: des_optd
    Discovery_Completed__c: ind_dsro_cocd_c
    Fiscal: des_ano_fisc
    FiscalQuarter: num_trme_fisc
    FiscalYear: ano_fisc
    ForecastCategory: cate_prvs
    ForecastCategoryName: nom_cate_prvs
    HasOpenActivity: ind_atii_aber
    HasOpportunityLineItem: ind_item_linh_asdo
    HasOverdueTask: ind_tare_vncd
    Id: cod_idt
    IsClosed: ind_optd_fech
    IsDeleted: idt_excu
    IsWon: ind_optd_cnqt
    LastModifiedById: cod_usua_ulti_alte
    LeadSource: nom_font_optd
    Name: des_nom
    NextStep: des_prox_etap
    OwnerId: num_idt_usua_optd
    Pricebook2Id: num_idt_price_book
    Probability: pbbbl_fecm_optd
    PushCount: num_cotg_envo
    RecordTypeId: cod_tipo_rgto
    StageName: des_idt_ctotc_snca
    SyncedQuoteId: cod_idt_trto
    Territory2Id: num_tipo
    Type: tip_oprt
    HU7_MotivoPerda__c: txt_moti_perd
    HU7_SubMotivoPerda__c: txt_sub_moti_perd
    HU7_SpreadConcorrente__c: num_sprd_crt
    HU7_Probabilidade__c: nom_pbbbl
    AccountIdSubGrupo__c: num_idt_cont_subg
    DataVencimentoConcorrente__c: dat_venc_conc_c
    EspecialistaTime__c: esp_time_c
    ExpectedRevenue: exp_reve
    HU7_Concorrente__c: cod_idt_conc_c
    HU7_ContactReport__c: cod_idt_ctc_repo_c
    HU7_Detalhes__c: txt_deta_c
    HU7_EmpresaGrupo__c: cod_idt_emp_grp_c
    HU7_EstimativaPotencial__c: num_est_pote_c
    HU7_IDExterno__c: cod_idt_exte_c
    HU7_IdVencimento__c: cod_idt_venc_c
    HU7_NomeOferta__c: nom_ofta_c
    HU7_Restrito__c: rest_c
    InformacaoAdicional__c: inf_adic_c
    IsPrivate: is_priv
    Participantes__c: txt_part_c
    TotalOpportunityQuantity: ttl_opp_qnty
  hash_ignore_cols: [ des_arq, dat_hor_psst, cod_patc ]

write:
  output_format: parquet
  overwrite_mode: dynamic
  show_counts: false   # obrigatório (sem default no código)
  repartition: 0       # 0 = sem repartition; sobrescrever por profile se quiser

dq:
  enable: true         # obrigatório (sem default no código)
  mode: basic          # sobrescrever por profile para 'builder' ou 'copy'
  # rules_path: s3://<bucket>/motor_data_quality/<db>/<tabela>/<tabela>.json  # se usar 'copy'
