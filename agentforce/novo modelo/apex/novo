public static List<AccountContactRelation__c> buscarContatos(List<Request> requisicoes) {
    Set<Id> accountIds = new Set<Id>();
    String nomeFiltro = null;

    for (Request req : requisicoes) {
        if (req.accountId != null) {
            accountIds.add(req.accountId);
        }
        if (!String.isBlank(req.nomeContato)) {
            nomeFiltro = req.nomeContato.trim();
        }
    }

    if (accountIds.isEmpty() && String.isBlank(nomeFiltro)) {
        return new List<AccountContactRelation__c>();
    }

    String query = 'SELECT Name, Email__c, Perfil__c, Cargo__c, AccountId__c, AccountId__r.Name, AccountId__r.Hu7IDExterno__c FROM AccountContactRelation__c';
    List<String> condicoes = new List<String>();

    if (!accountIds.isEmpty()) {
        String idsStr = '(' + String.join(new List<String>(accountIds), '\',\'') + ')';
        condicoes.add('AccountId__c IN (\'' + idsStr + '\')');
    }

    if (!String.isBlank(nomeFiltro)) {
        String nomeEscapado = String.escapeSingleQuotes(nomeFiltro);
        condicoes.add('Name LIKE \'' + nomeEscapado + '%\'');
    }

    if (!condicoes.isEmpty()) {
        query += ' WHERE ' + String.join(condicoes, ' AND ');
    }

    return Database.query(query);
}



if (!accountIds.isEmpty()) {
    String idsStr = '\'' + String.join(new List<String>(accountIds.stream().map(String.valueOf)), '\',\'') + '\'';
    condicoes.add('AccountId__c IN (' + idsStr + ')');
}


if (!accountIds.isEmpty()) {
    List<String> idStrList = new List<String>();
    for (Id id : accountIds) {
        idStrList.add('\'' + String.valueOf(id) + '\'');
    }
    condicoes.add('AccountId__c IN (' + String.join(idStrList, ',') + ')');
}
