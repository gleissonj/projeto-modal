import boto3
import csv
import io

# Cliente S3
s3 = boto3.client('s3')

def lambda_handler(event, context):
    bucket = event['bucket']
    key = event['key']
    
    try:
        # Recuperando o arquivo do S3
        response = s3.get_object(Bucket=bucket, Key=key)
        file_content = response['Body'].read().decode('utf-8')  # decodificando para string
        
        # Lendo o CSV usando csv.reader
        csv_file = io.StringIO(file_content)
        csv_reader = csv.DictReader(csv_file)  # usa os nomes das colunas como chave
        
        # Processando os dados linha por linha
        for row in csv_reader:
            nome = row.get('nome', '')
            email = row.get('email', '')
            idade = row.get('idade', '')
            print(f"Nome: {nome}, Email: {email}, Idade: {idade}")
        
        return {
            "statusCode": 200,
            "body": "Arquivo CSV lido e processado com sucesso."
        }

    except Exception as e:
        print(f"Erro ao processar o arquivo: {str(e)}")
        return {
            "statusCode": 500,
            "body": f"Erro ao processar o arquivo: {str(e)}"
        }
