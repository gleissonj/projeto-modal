import { ComponentFixture, TestBed } from '@angular/core/testing';
import { YourComponent } from './your-component';
import { MultipartUploadService } from 'path-to-service';
import { of } from 'rxjs';

describe('YourComponent', () => {
  let component: YourComponent;
  let fixture: ComponentFixture<YourComponent>;
  let multipartUploadServiceMock: any;

  beforeEach(() => {
    multipartUploadServiceMock = {
      responseWithSuccessOrError$: of({ message: 'Erro ao processar' }),
    };

    TestBed.configureTestingModule({
      declarations: [YourComponent],
      providers: [
        { provide: MultipartUploadService, useValue: multipartUploadServiceMock }
      ]
    });

    fixture = TestBed.createComponent(YourComponent);
    component = fixture.componentInstance;

    // Espiando os mÃ©todos
    jest.spyOn(component, 'verificaAutorizacao');
    jest.spyOn(component, 'verificaUserOportunidades');
    jest.spyOn(component, 'updateFileMultiple');
    jest.spyOn(component, 'startStepFunctionProspect');
    jest.spyOn(component, 'showMessage');

    // Mock localStorage
    const store = { gruposAcessos: JSON.stringify(['admin']) };
    jest.spyOn(localStorage.__proto__, 'getItem').mockImplementation((key: string) => store[key]);

    // Dados de simulaÃ§Ã£o
    component.nameFunc = 'Prospect';
    component.selectedFiles = [];
  });

  it('deve executar ngOnInit corretamente', (done) => {
    component.ngOnInit();

    expect(component.verificaAutorizacao).toHaveBeenCalled();
    expect(component.verificaUserOportunidades).toHaveBeenCalled();
    expect(component.gruposAcessos).toEqual(['admin']);

    // Aguarda o setTimeout
    setTimeout(() => {
      expect(component.startStepFunctionProspect).toHaveBeenCalled();
      expect(component.showMessage).toHaveBeenCalledWith('Erro ao processar', 'error');
      done();
    }, 5100);
  });
});



const store: Record<string, string> = {
  gruposAcessos: JSON.stringify(['admin'])
};

jest.spyOn(window.localStorage.__proto__, 'getItem')
  .mockImplementation((key: string) => store[key]);


jest.spyOn(localStorage.__proto__, 'getItem')
  .mockImplementation((...args: unknown[]) => {
    const key = args[0] as string;
    return store[key];
  });




describe('YourComponent', () => {
  let getItemSpy: jest.SpyInstance;

  beforeEach(() => {
    const store = {
      gruposAcessos: JSON.stringify(['admin']),
    };

    getItemSpy = jest.spyOn(window.localStorage.__proto__, 'getItem')
      .mockImplementation((key: string) => store[key]);
  });

  afterEach(() => {
    getItemSpy.mockRestore(); // ðŸ” Restaura o original apÃ³s cada teste
  });

  it('deve executar ngOnInit corretamente', (done) => {
    // ... seu teste
  });
});
